<?php

declare(strict_types=1);

namespace App\Http\Controllers;

use App\Http\Requests\NewsletterSubscribeRequest;
use App\Models\Subscriber;
use Illuminate\Http\RedirectResponse;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

/**
 * Контроллер для управления email-рассылкой
 * 
 * Отвечает за подписку и отписку пользователей на новостную рассылку.
 * Форма подписки обычно располагается в футере сайта.
 * 
 * ФУНКЦИОНАЛЬНОСТЬ:
 * - Подписка новых email адресов
 * - Отписка по уникальному токену
 * - Повторная подписка ранее отписавшихся
 * - Защита от дубликатов
 */
final class NewsletterController extends Controller
{
    /**
     * Подписать пользователя на рассылку
     * 
     * Обрабатывает форму подписки на email-рассылку.
     * 
     * ПРОЦЕСС ПОДПИСКИ:
     * 
     * 1. ВАЛИДАЦИЯ (в NewsletterSubscribeRequest):
     *    - Email должен быть корректным
     *    - Email не должен быть уже подписан
     *    - Дополнительные поля (имя, категории)
     * 
     * 2. ПРОВЕРКА НА ПОВТОРНУЮ ПОДПИСКУ:
     *    - Если email ранее отписался (is_active = false)
     *    - Активируем старую запись вместо создания новой
     * 
     * 3. СОЗДАНИЕ ПОДПИСЧИКА:
     *    - Создаем новую запись в БД
     *    - Генерируем уникальный токен для отписки
     *    - Устанавливаем дату подписки
     * 
     * 4. ОТПРАВКА ПИСЬМА (опционально):
     *    - Приветственное письмо
     *    - Подтверждение подписки (double opt-in)
     * 
     * @param NewsletterSubscribeRequest $request Валидированный запрос
     * @return RedirectResponse Редирект обратно с сообщением
     */
    public function subscribe(NewsletterSubscribeRequest $request): RedirectResponse
    {
        try {
            // ==========================================
            // ПОЛУЧЕНИЕ ВАЛИДИРОВАННЫХ ДАННЫХ
            // ==========================================
            // 
            // Данные прошли валидацию в NewsletterSubscribeRequest:
            // - email: валидный, уникальный среди активных подписок
            // - name: необязательное, только буквы
            // - categories: массив ID интересующих категорий
            // 
            // validated() также добавляет:
            // - ip_address: IP адрес подписчика
            // - user_agent: браузер/устройство
            $validated = $request->validated();

            // ==========================================
            // ПРОВЕРКА НА ПОВТОРНУЮ ПОДПИСКУ
            // ==========================================
            // 
            // Если пользователь ранее отписался, не создаем новую запись,
            // а реактивируем старую. Это сохраняет историю подписок.
            $existingSubscriber = Subscriber::where('email', $validated['email'])
                ->first();

            if ($existingSubscriber) {
                if ($existingSubscriber->is_active) {
                    // Подписчик уже активен
                    // Этого не должно произойти из-за валидации,
                    // но на всякий случай проверяем
                    return redirect()
                        ->back()
                        ->with('info', 'Этот email уже подписан на рассылку!');
                }

                // Реактивируем отписавшегося пользователя
                $existingSubscriber->resubscribe();

                Log::info('Повторная подписка на рассылку', [
                    'email' => $validated['email'],
                    'subscriber_id' => $existingSubscriber->id,
                ]);

                return redirect()
                    ->back()
                    ->with('success', 'Вы успешно подписались на рассылку! Спасибо!');
            }

            // ==========================================
            // СОЗДАНИЕ НОВОЙ ПОДПИСКИ
            // ==========================================
            // 
            // Используем транзакцию для обеспечения целостности данных
            DB::transaction(function () use ($validated) {
                // Создаем запись подписчика
                // token и subscribed_at генерируются автоматически в модели
                $subscriber = Subscriber::create([
                    'email' => $validated['email'],
                    'name' => $validated['name'] ?? null,
                    'ip_address' => $validated['ip_address'],
                    'user_agent' => $validated['user_agent'],
                    'is_active' => true,
                ]);

                // Если указаны интересующие категории, сохраняем их
                // (требуется таблица subscriber_categories для связи many-to-many)
                if (isset($validated['categories']) && !empty($validated['categories'])) {
                    // TODO: Реализовать связь many-to-many с категориями
                    // $subscriber->categories()->attach($validated['categories']);
                }

                // ==========================================
                // ОТПРАВКА ПРИВЕТСТВЕННОГО ПИСЬМА
                // ==========================================
                // 
                // TODO: Реализовать отправку email
                // Mail::to($subscriber->email)->send(new WelcomeNewsletterMail($subscriber));
                // 
                // Письмо должно содержать:
                // - Приветствие и благодарность за подписку
                // - Информацию о том, какие рассылки будет получать
                // - Ссылку для отписки
                // - Контактную информацию

                Log::info('Новая подписка на рассылку', [
                    'email' => $subscriber->email,
                    'subscriber_id' => $subscriber->id,
                    'ip' => $validated['ip_address'],
                ]);
            });

            // ==========================================
            // ВОЗВРАТ УСПЕШНОГО ОТВЕТА
            // ==========================================
            return redirect()
                ->back()
                ->with('success', 'Спасибо за подписку! Проверьте вашу почту.');

        } catch (\Exception $e) {
            // ==========================================
            // ОБРАБОТКА ОШИБОК
            // ==========================================
            Log::error('Ошибка при подписке на рассылку', [
                'email' => $validated['email'] ?? null,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Произошла ошибка при подписке. Попробуйте позже.');
        }
    }

    /**
     * Отписать пользователя от рассылки
     * 
     * Обрабатывает переход по ссылке отписки из email-письма.
     * 
     * ПРОЦЕСС ОТПИСКИ:
     * 
     * 1. ПОИСК ПОДПИСЧИКА ПО ТОКЕНУ:
     *    - Каждый подписчик имеет уникальный токен
     *    - Токен передается в URL: /newsletter/unsubscribe/{token}
     * 
     * 2. ДЕАКТИВАЦИЯ ПОДПИСКИ:
     *    - Устанавливаем is_active = false
     *    - Сохраняем дату отписки (unsubscribed_at)
     *    - Запись остается в БД для статистики
     * 
     * 3. ВОЗВРАТ РЕЗУЛЬТАТА:
     *    - Показываем страницу с подтверждением отписки
     *    - Опционально: форма для повторной подписки
     * 
     * @param string $token Уникальный токен подписчика
     * @return RedirectResponse Редирект на главную с сообщением
     */
    public function unsubscribe(string $token): RedirectResponse
    {
        try {
            // ==========================================
            // ПОИСК ПОДПИСЧИКА ПО ТОКЕНУ
            // ==========================================
            // 
            // where('token', $token) - ищем по уникальному токену
            // firstOrFail() - возвращает подписчика или 404 если не найден
            $subscriber = Subscriber::where('token', $token)
                ->firstOrFail();

            // ==========================================
            // ПРОВЕРКА СТАТУСА ПОДПИСКИ
            // ==========================================
            // 
            // Если подписчик уже отписан, не выполняем повторную отписку
            if (!$subscriber->is_active) {
                return redirect()
                    ->route('home')
                    ->with('info', 'Вы уже отписаны от рассылки.');
            }

            // ==========================================
            // ОТПИСКА ОТ РАССЫЛКИ
            // ==========================================
            // 
            // Метод unsubscribe() определен в модели Subscriber
            // Он устанавливает:
            // - is_active = false
            // - unsubscribed_at = now()
            $subscriber->unsubscribe();

            // ==========================================
            // ЛОГИРОВАНИЕ ОТПИСКИ
            // ==========================================
            Log::info('Отписка от рассылки', [
                'email' => $subscriber->email,
                'subscriber_id' => $subscriber->id,
                'token' => $token,
            ]);

            // ==========================================
            // ОТПРАВКА ПОДТВЕРЖДАЮЩЕГО ПИСЬМА
            // ==========================================
            // 
            // TODO: Опционально отправить письмо с подтверждением отписки
            // Mail::to($subscriber->email)->send(new UnsubscribeConfirmationMail($subscriber));
            // 
            // Письмо должно содержать:
            // - Подтверждение отписки
            // - Причины, по которым стоит остаться (опционально)
            // - Ссылку для повторной подписки
            // - Обратную связь для улучшения рассылки

            // ==========================================
            // ВОЗВРАТ УСПЕШНОГО ОТВЕТА
            // ==========================================
            return redirect()
                ->route('home')
                ->with('success', 'Вы успешно отписались от рассылки. Жаль расставаться!');

        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            // ==========================================
            // ОБРАБОТКА НЕСУЩЕСТВУЮЩЕГО ТОКЕНА
            // ==========================================
            Log::warning('Попытка отписки с несуществующим токеном', [
                'token' => $token,
            ]);

            return redirect()
                ->route('home')
                ->with('error', 'Ссылка для отписки недействительна или устарела.');

        } catch (\Exception $e) {
            // ==========================================
            // ОБРАБОТКА ДРУГИХ ОШИБОК
            // ==========================================
            Log::error('Ошибка при отписке от рассылки', [
                'token' => $token,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()
                ->route('home')
                ->with('error', 'Произошла ошибка при отписке. Попробуйте позже.');
        }
    }
}
