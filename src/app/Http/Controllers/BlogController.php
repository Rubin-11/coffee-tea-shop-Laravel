<?php

declare(strict_types=1);

namespace App\Http\Controllers;

use App\Models\BlogPost;
use Illuminate\Contracts\View\View;
use Illuminate\Http\Request;

/**
 * Контроллер для работы с блогом
 * 
 * Отвечает за отображение статей блога магазина.
 * Блог содержит статьи на темы:
 * - "Здоровое питание"
 * - "Рецепты с кофе"
 * - "Гид по выбору кофе"
 * - "История происхождения"
 * 
 * Контроллер выполняет только простую логику отображения,
 * вся работа с данными происходит через модель BlogPost.
 */
final class BlogController extends Controller
{
    /**
     * Отображение списка статей блога
     * 
     * Показывает опубликованные статьи с пагинацией и фильтрацией.
     * 
     * ФУНКЦИОНАЛЬНОСТЬ:
     * 
     * 1. ФИЛЬТРАЦИЯ ПО КАТЕГОРИИ (опционально):
     *    - Если указан параметр ?category=Рецепты
     *    - Показываем только статьи этой категории
     * 
     * 2. СОРТИРОВКА:
     *    - По умолчанию по дате публикации (новые первые)
     *    - Опционально можно добавить сортировку по популярности
     * 
     * 3. ПАГИНАЦИЯ:
     *    - По 12 статей на странице
     *    - Laravel автоматически обрабатывает параметр ?page=
     * 
     * 4. ДАННЫЕ ДЛЯ ФИЛЬТРОВ:
     *    - Получаем список всех уникальных категорий
     *    - Для отображения меню фильтрации
     * 
     * @param Request $request HTTP запрос с параметрами фильтрации
     * @return View Представление со списком статей
     */
    public function index(Request $request): View
    {
        // ==========================================
        // ПОСТРОЕНИЕ ЗАПРОСА К БД
        // ==========================================
        // 
        // Начинаем с базового запроса - только опубликованные статьи
        $query = BlogPost::published()
            ->with('author'); // Eager loading автора для избежания N+1 проблемы

        // ==========================================
        // ФИЛЬТРАЦИЯ ПО КАТЕГОРИИ
        // ==========================================
        // 
        // Если в URL есть параметр ?category=...
        // Фильтруем статьи по этой категории
        if ($request->filled('category')) {
            $category = $request->input('category');
            $query->byCategory($category);
        }

        // ==========================================
        // СОРТИРОВКА ПО ПАРАМЕТРУ
        // ==========================================
        // 
        // Поддерживаем разные варианты сортировки:
        // - latest (по умолчанию) - новые первые
        // - popular - по количеству просмотров
        $sortBy = $request->input('sort', 'latest');

        match ($sortBy) {
            'popular' => $query->popular(),      // Сортировка по просмотрам
            'latest' => $query->latestFirst(),   // Сортировка по дате публикации
            default => $query->latestFirst(),    // По умолчанию - по дате
        };

        // ==========================================
        // ПОЛУЧЕНИЕ СТАТЕЙ С ПАГИНАЦИЕЙ
        // ==========================================
        // 
        // paginate(12) автоматически:
        // - Разбивает результаты на страницы по 12 статей
        // - Обрабатывает параметр ?page= из URL
        // - Генерирует ссылки на другие страницы
        // - Сохраняет GET параметры (category, sort) в ссылках
        $posts = $query->paginate(12)
            ->withQueryString(); // Сохраняем параметры фильтрации в пагинации

        // ==========================================
        // ПОЛУЧЕНИЕ СПИСКА КАТЕГОРИЙ
        // ==========================================
        // 
        // Получаем уникальные категории для меню фильтров
        // pluck('category') - берет только поле category из всех статей
        // unique() - оставляет только уникальные значения
        // values() - переиндексирует массив (0, 1, 2...)
        $categories = BlogPost::published()
            ->pluck('category')
            ->unique()
            ->values();

        // ==========================================
        // ПОЛУЧЕНИЕ ПОПУЛЯРНЫХ СТАТЕЙ ДЛЯ САЙДБАРА
        // ==========================================
        // 
        // Показываем 5 самых популярных статей в боковой колонке
        // Это помогает пользователям найти интересный контент
        $popularPosts = BlogPost::published()
            ->popular()
            ->limit(5)
            ->get();

        // ==========================================
        // ВОЗВРАТ ПРЕДСТАВЛЕНИЯ С ДАННЫМИ
        // ==========================================
        return view('blog.index', compact(
            'posts',         // Статьи с пагинацией
            'categories',    // Список категорий для фильтра
            'popularPosts',  // Популярные статьи для сайдбара
        ));
    }

    /**
     * Отображение отдельной статьи блога
     * 
     * Показывает полный текст статьи и увеличивает счетчик просмотров.
     * 
     * ФУНКЦИОНАЛЬНОСТЬ:
     * 
     * 1. ПОЛУЧЕНИЕ СТАТЬИ:
     *    - По slug (URL-дружественное название)
     *    - Только опубликованные статьи
     *    - С загрузкой автора
     * 
     * 2. УВЕЛИЧЕНИЕ СЧЕТЧИКА ПРОСМОТРОВ:
     *    - Каждый просмотр увеличивает views_count
     *    - Используется для статистики и сортировки по популярности
     * 
     * 3. ПОХОЖИЕ СТАТЬИ:
     *    - Статьи из той же категории
     *    - Исключая текущую статью
     *    - Для удержания пользователя на сайте
     * 
     * @param string $slug URL-идентификатор статьи
     * @return View Представление со статьей
     */
    public function show(string $slug): View
    {
        // ==========================================
        // ПОЛУЧЕНИЕ СТАТЬИ ИЗ БД
        // ==========================================
        // 
        // published() - только опубликованные статьи
        // where('slug', $slug) - поиск по URL-идентификатору
        // with('author') - загружаем автора (избегаем N+1)
        // firstOrFail() - возвращает статью или 404 если не найдена
        $post = BlogPost::published()
            ->where('slug', $slug)
            ->with('author')
            ->firstOrFail();

        // ==========================================
        // УВЕЛИЧЕНИЕ СЧЕТЧИКА ПРОСМОТРОВ
        // ==========================================
        // 
        // Метод incrementViews() определен в модели BlogPost
        // Он увеличивает поле views_count на 1
        // 
        // ВАЖНО: Это простая реализация счетчика.
        // В продакшене стоит использовать:
        // - Кэширование IP для защиты от накрутки
        // - Очереди для асинхронного обновления
        // - Отдельную таблицу для детальной статистики
        $post->incrementViews();

        // ==========================================
        // ПОЛУЧЕНИЕ ПОХОЖИХ СТАТЕЙ
        // ==========================================
        // 
        // Выбираем статьи из той же категории
        // Исключаем текущую статью
        // Ограничиваем до 3 статей
        // Показываем в конце статьи как рекомендации
        $relatedPosts = BlogPost::published()
            ->byCategory($post->category)
            ->where('id', '!=', $post->id) // Исключаем текущую статью
            ->latest('published_at')
            ->limit(3)
            ->get();

        // ==========================================
        // ВОЗВРАТ ПРЕДСТАВЛЕНИЯ С ДАННЫМИ
        // ==========================================
        return view('blog.show', compact(
            'post',          // Текущая статья
            'relatedPosts',  // Похожие статьи для рекомендаций
        ));
    }
}
