<?php

declare(strict_types=1);

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

/**
 * Запрос для валидации фильтров и параметров сортировки товаров
 * 
 * Этот класс обрабатывает все параметры фильтрации в каталоге товаров:
 * - Фильтрация по категории
 * - Фильтрация по ценовому диапазону
 * - Фильтрация по тегам
 * - Сортировка товаров (по цене, рейтингу, названию)
 * - Поиск по ключевым словам
 */
final class ProductFilterRequest extends FormRequest
{
    /**
     * Определить, авторизован ли пользователь для выполнения этого запроса
     * 
     * @return bool Возвращает true, так как фильтрация доступна всем
     */
    public function authorize(): bool
    {
        // Фильтрация товаров доступна всем пользователям, включая гостей
        return true;
    }

    /**
     * Правила валидации для запроса
     * 
     * Описание полей:
     * - category: ID категории для фильтрации (должна существовать в БД)
     * - min_price: Минимальная цена в рублях (не меньше 0)
     * - max_price: Максимальная цена в рублях (не меньше min_price)
     * - tags: Массив ID тегов для фильтрации
     * - sort: Тип сортировки (популярные, новинки, цена, название)
     * - search: Поисковой запрос (минимум 2 символа)
     * - per_page: Количество товаров на странице (от 12 до 48)
     * 
     * @return array<string, mixed>
     */
    public function rules(): array
    {
        return [
            // Валидация категории
            // nullable - поле необязательное
            // integer - должно быть целым числом
            // exists - проверяет существование категории в таблице categories
            'category' => [
                'nullable',
                'integer',
                'exists:categories,id',
            ],

            // Валидация минимальной цены
            // nullable - можно не указывать
            // numeric - разрешены числа с плавающей точкой
            // min:0 - цена не может быть отрицательной
            'min_price' => [
                'nullable',
                'numeric',
                'min:0',
            ],

            // Валидация максимальной цены
            // gte - greater than or equal (больше или равно min_price)
            'max_price' => [
                'nullable',
                'numeric',
                'min:0',
                'gte:min_price', // Максимальная цена должна быть >= минимальной
            ],

            // Валидация тегов
            // array - должен быть массивом
            // tags.* - правила для каждого элемента массива
            'tags' => [
                'nullable',
                'array',
            ],
            'tags.*' => [
                'integer',
                'exists:tags,id', // Каждый тег должен существовать в БД
            ],

            // Валидация типа сортировки
            // in - значение должно быть из списка разрешенных
            'sort' => [
                'nullable',
                'string',
                'in:popular,newest,price_asc,price_desc,name_asc,name_desc,rating', // Доступные типы сортировки
            ],

            // Валидация поискового запроса
            // min:2 - минимум 2 символа для поиска
            // max:100 - максимум 100 символов
            'search' => [
                'nullable',
                'string',
                'min:2',
                'max:100',
            ],

            // Валидация количества товаров на странице
            // between - значение должно быть в диапазоне 12-48
            'per_page' => [
                'nullable',
                'integer',
                'between:12,48',
            ],

            // Валидация фильтра "только в наличии"
            'in_stock' => [
                'nullable',
                'boolean',
            ],

            // Валидация фильтра "только со скидкой"
            'on_sale' => [
                'nullable',
                'boolean',
            ],
        ];
    }

    /**
     * Пользовательские сообщения об ошибках валидации
     * 
     * Эти сообщения будут показаны пользователю при ошибке валидации
     * 
     * @return array<string, string>
     */
    public function messages(): array
    {
        return [
            // Сообщения для категории
            'category.integer' => 'ID категории должен быть числом',
            'category.exists' => 'Выбранная категория не существует',

            // Сообщения для цен
            'min_price.numeric' => 'Минимальная цена должна быть числом',
            'min_price.min' => 'Минимальная цена не может быть отрицательной',
            'max_price.numeric' => 'Максимальная цена должна быть числом',
            'max_price.min' => 'Максимальная цена не может быть отрицательной',
            'max_price.gte' => 'Максимальная цена должна быть больше или равна минимальной',

            // Сообщения для тегов
            'tags.array' => 'Теги должны быть переданы в виде массива',
            'tags.*.integer' => 'ID тега должен быть числом',
            'tags.*.exists' => 'Один из выбранных тегов не существует',

            // Сообщения для сортировки
            'sort.in' => 'Выбран недопустимый тип сортировки',

            // Сообщения для поиска
            'search.min' => 'Поисковой запрос должен содержать минимум :min символа',
            'search.max' => 'Поисковой запрос не должен превышать :max символов',

            // Сообщения для пагинации
            'per_page.between' => 'Количество товаров на странице должно быть от :min до :max',

            // Сообщения для булевых фильтров
            'in_stock.boolean' => 'Фильтр "В наличии" должен быть true или false',
            'on_sale.boolean' => 'Фильтр "Со скидкой" должен быть true или false',
        ];
    }

    /**
     * Получить валидированные данные с значениями по умолчанию
     * 
     * Этот метод возвращает отвалидированные данные и устанавливает
     * значения по умолчанию для необязательных полей
     * 
     * @return array<string, mixed>
     */
    public function validated($key = null, $default = null): array
    {
        $validated = parent::validated();

        // Устанавливаем значения по умолчанию
        return array_merge([
            'category' => null,
            'min_price' => null,
            'max_price' => null,
            'tags' => [],
            'sort' => 'popular', // Сортировка по умолчанию - популярные
            'search' => null,
            'per_page' => 24, // По умолчанию 24 товара на странице
            'in_stock' => false,
            'on_sale' => false,
        ], $validated);
    }
}
