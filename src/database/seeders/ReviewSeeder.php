<?php

namespace Database\Seeders;

use App\Models\Product;
use App\Models\Review;
use App\Models\User;
use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;

/**
 * Seeder Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ½Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹
 * 
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ñ€ĞµĞ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²:
 * - ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹: 8-12 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
 * - Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹: 3-5 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
 * - ĞĞ¾Ğ²Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹: 0-2 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ°
 * 
 * ĞŸĞ¾ÑĞ»Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ¸ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
 */
class ReviewSeeder extends Seeder
{
    use WithoutModelEvents;

    /**
     * Ğ—Ğ°Ğ¿ÑƒÑĞº seeder'Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
     * 
     * ĞŸÑ€Ğ¾Ñ†ĞµÑÑ:
     * 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸Ğ· Ğ‘Ğ”
     * 2. Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾ÑÑ‚Ğ¸
     * 3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
     * 4. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¸ Ğ¸ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸ĞºĞ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
     * 
     * @return void
     */
    public function run(): void
    {
        $this->command->info('ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ½Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹...');

        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
        $products = Product::all();
        $users = User::all();

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        if ($products->isEmpty()) {
            $this->command->error('âŒ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹! Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ProductSeeder.');
            return;
        }

        if ($users->isEmpty()) {
            $this->command->error('âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹! Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ UserSeeder.');
            return;
        }

        // Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾ÑÑ‚Ğ¸
        $productsCount = $products->count();
        
        // ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 25%) - Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
        $popularProducts = $products->take((int) ceil($productsCount * 0.25));
        
        // Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ (ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ 50%) - Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ ÑÑ€ĞµĞ´Ğ½ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
        $mediumProducts = $products->skip($popularProducts->count())->take((int) ceil($productsCount * 0.5));
        
        // ĞĞ¾Ğ²Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ (Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞ¸ĞµÑÑ 25%) - Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ Ğ¼Ğ°Ğ»Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ Ğ²Ğ¾Ğ²ÑĞµ
        $newProducts = $products->skip($popularProducts->count() + $mediumProducts->count());

        $totalReviews = 0;

        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² (8-12 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²)
        $this->command->info("   Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² ({$popularProducts->count()} ÑˆÑ‚.)...");
        $totalReviews += $this->createReviewsForProducts($popularProducts, $users, 8, 12);

        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ´Ğ»Ñ ÑÑ€ĞµĞ´Ğ½Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² (3-5 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²)
        $this->command->info("   Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ ÑÑ€ĞµĞ´Ğ½Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² ({$mediumProducts->count()} ÑˆÑ‚.)...");
        $totalReviews += $this->createReviewsForProducts($mediumProducts, $users, 3, 5);

        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² (0-2 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ°)
        $this->command->info("   Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² ({$newProducts->count()} ÑˆÑ‚.)...");
        $totalReviews += $this->createReviewsForProducts($newProducts, $users, 0, 2);

        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¸ Ğ¸ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
        $this->command->info('   ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¾Ğ² Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²...');
        $this->updateProductRatings($products);

        // Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
        $this->command->newLine();
        $this->command->info("âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ {$totalReviews} Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²");
        $this->command->info("   ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹: {$popularProducts->count()} (8-12 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹)");
        $this->command->info("   Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹: {$mediumProducts->count()} (3-5 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹)");
        $this->command->info("   ĞĞ¾Ğ²Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹: {$newProducts->count()} (0-2 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹)");
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
     * 
     * Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ² Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ.
     * ĞÑ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğº ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼.
     * ĞĞ´Ğ¸Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ğ¾Ñ‚Ğ·Ñ‹Ğ² Ğ½Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€.
     * 
     * @param \Illuminate\Support\Collection $products ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
     * @param \Illuminate\Support\Collection $users ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
     * @param int $minReviews ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
     * @param int $maxReviews ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
     * @return int ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
     */
    private function createReviewsForProducts($products, $users, int $minReviews, int $maxReviews): int
    {
        $createdCount = 0;

        foreach ($products as $product) {
            // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
            $reviewsCount = rand($minReviews, $maxReviews);

            // Ğ•ÑĞ»Ğ¸ 0 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² - Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€
            if ($reviewsCount === 0) {
                continue;
            }

            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ½Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ, Ñ‡ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
            $reviewsCount = min($reviewsCount, $users->count());

            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² (Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ĞµĞ½Ğ¸Ğ¹)
            $selectedUsers = $users->random($reviewsCount);

            // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ¾Ñ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
            foreach ($selectedUsers as $user) {
                Review::factory()->create([
                    'product_id' => $product->id,
                    'user_id' => $user->id,
                ]);

                $createdCount++;
            }
        }

        return $createdCount;
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¾Ğ² Ğ¸ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸ĞºĞ¾Ğ² Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
     * 
     * Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ:
     * - rating: ÑÑ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ¸Ğ· Ğ²ÑĞµÑ… Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² (Ğ¾Ñ‚ 0.00 Ğ´Ğ¾ 5.00)
     * - reviews_count: ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
     * 
     * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ (is_approved = true),
     * Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ½ĞµĞ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ²Ğ»Ğ¸ÑÑ‚ÑŒ Ğ½Ğ° Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³.
     * 
     * @param \Illuminate\Support\Collection $products ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
     * @return void
     */
    private function updateProductRatings($products): void
    {
        foreach ($products as $product) {
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
            $approvedReviews = Review::where('product_id', $product->id)
                ->where('is_approved', true)
                ->get();

            // Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² - ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
            if ($approvedReviews->isEmpty()) {
                $product->update([
                    'rating' => 0,
                    'reviews_count' => 0,
                ]);
                continue;
            }

            // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ ÑÑ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ (Ñ Ğ´Ğ²ÑƒĞ¼Ñ Ğ·Ğ½Ğ°ĞºĞ°Ğ¼Ğ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿ÑÑ‚Ğ¾Ğ¹)
            $averageRating = round($approvedReviews->avg('rating'), 2);

            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€
            $product->update([
                'rating' => $averageRating,
                'reviews_count' => $approvedReviews->count(),
            ]);
        }
    }
}
